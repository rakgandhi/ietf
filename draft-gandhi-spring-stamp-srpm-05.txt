



SPRING Working Group                                      R. Gandhi, Ed.
Internet-Draft                                               C. Filsfils
Intended status: Standards Track                     Cisco Systems, Inc.
Expires: July 29, 2021                                          D. Voyer
                                                             Bell Canada
                                                                 M. Chen
                                                                  Huawei
                                                             B. Janssens
                                                                    Colt
                                                        January 25, 2021


 Performance Measurement Using Simple TWAMP (STAMP) for Segment Routing
                                Networks
                   draft-gandhi-spring-stamp-srpm-05

Abstract

   Segment Routing (SR) leverages the source routing paradigm.  SR is
   applicable to both Multiprotocol Label Switching (SR-MPLS) and IPv6
   (SRv6) data planes.  This document specifies procedure for sending
   and processing test packets for Performance Measurement (PM) in
   Segment Routing networks.  The procedure uses the mechanisms defined
   in RFC 8762 (Simple Two-Way Active Measurement Protocol (STAMP)) and
   its optional extensions defined in RFC 8972 for Performance
   Measurement.  The procedure specified is applicable to SR-MPLS and
   SRv6 data planes and is used for both links and end-to-end SR paths
   including SR Policies.

Status of This Memo

   This Internet-Draft is submitted in full conformance with the
   provisions of BCP 78 and BCP 79.

   Internet-Drafts are working documents of the Internet Engineering
   Task Force (IETF).  Note that other groups may also distribute
   working documents as Internet-Drafts.  The list of current Internet-
   Drafts is at https://datatracker.ietf.org/drafts/current/.

   Internet-Drafts are draft documents valid for a maximum of six months
   and may be updated, replaced, or obsoleted by other documents at any
   time.  It is inappropriate to use Internet-Drafts as reference
   material or to cite them other than as "work in progress."

   This Internet-Draft will expire on July 29, 2021.






Gandhi, et al.            Expires July 29, 2021                 [Page 1]

Internet-Draft       Using STAMP for Segment Routing        January 2021


Copyright Notice

   Copyright (c) 2021 IETF Trust and the persons identified as the
   document authors.  All rights reserved.

   This document is subject to BCP 78 and the IETF Trust's Legal
   Provisions Relating to IETF Documents
   (https://trustee.ietf.org/license-info) in effect on the date of
   publication of this document.  Please review these documents
   carefully, as they describe your rights and restrictions with respect
   to this document.  Code Components extracted from this document must
   include Simplified BSD License text as described in Section 4.e of
   the Trust Legal Provisions and are provided without warranty as
   described in the Simplified BSD License.

Table of Contents

   1.  Introduction  . . . . . . . . . . . . . . . . . . . . . . . .   3
   2.  Conventions Used in This Document . . . . . . . . . . . . . .   3
     2.1.  Requirements Language . . . . . . . . . . . . . . . . . .   3
     2.2.  Abbreviations . . . . . . . . . . . . . . . . . . . . . .   3
     2.3.  Reference Topology  . . . . . . . . . . . . . . . . . . .   4
   3.  Overview  . . . . . . . . . . . . . . . . . . . . . . . . . .   5
     3.1.  Example Provisioning Model  . . . . . . . . . . . . . . .   6
   4.  Test Packets  . . . . . . . . . . . . . . . . . . . . . . . .   7
     4.1.  Session-Sender Test Packet  . . . . . . . . . . . . . . .   7
       4.1.1.  Delay Measurement Query Message . . . . . . . . . . .   7
       4.1.2.  Loss Measurement Query Message  . . . . . . . . . . .   8
       4.1.3.  Probe Query for links . . . . . . . . . . . . . . . .   9
       4.1.4.  Probe Query for SR Policy . . . . . . . . . . . . . .   9
     4.2.  Session-Reflector Test Packet . . . . . . . . . . . . . .  11
       4.2.1.  One-way Measurement Mode  . . . . . . . . . . . . . .  12
       4.2.2.  Two-way Measurement Mode  . . . . . . . . . . . . . .  12
       4.2.3.  Loopback Measurement Mode . . . . . . . . . . . . . .  14
     4.3.  Additional Test Packet Processing Rules . . . . . . . . .  15
       4.3.1.  TTL and Hop Limit . . . . . . . . . . . . . . . . . .  15
       4.3.2.  Router Alert Option . . . . . . . . . . . . . . . . .  15
   5.  Performance Measurement for P2MP SR Policies  . . . . . . . .  15
   6.  ECMP Support for SR Policies  . . . . . . . . . . . . . . . .  16
   7.  Performance Delay and Liveness Monitoring . . . . . . . . . .  17
   8.  Security Considerations . . . . . . . . . . . . . . . . . . .  17
   9.  IANA Considerations . . . . . . . . . . . . . . . . . . . . .  18
   10. References  . . . . . . . . . . . . . . . . . . . . . . . . .  18
     10.1.  Normative References . . . . . . . . . . . . . . . . . .  18
     10.2.  Informative References . . . . . . . . . . . . . . . . .  18
   Acknowledgments . . . . . . . . . . . . . . . . . . . . . . . . .  21
   Authors' Addresses  . . . . . . . . . . . . . . . . . . . . . . .  21




Gandhi, et al.            Expires July 29, 2021                 [Page 2]

Internet-Draft       Using STAMP for Segment Routing        January 2021


1.  Introduction

   Segment Routing (SR) leverages the source routing paradigm and
   greatly simplifies network operations for Software Defined Networks
   (SDNs).  SR is applicable to both Multiprotocol Label Switching (SR-
   MPLS) and IPv6 (SRv6) data planes.  SR takes advantage of the Equal-
   Cost Multipaths (ECMPs) between source and transit nodes, between
   transit nodes and between transit and destination nodes.  SR Policies
   as defined in [I-D.ietf-spring-segment-routing-policy] are used to
   steer traffic through a specific, user-defined paths using a stack of
   Segments.  Built-in SR Performance Measurement (PM) is one of the
   essential requirements to provide Service Level Agreements (SLAs).

   The Simple Two-way Active Measurement Protocol (STAMP) provides
   capabilities for the measurement of various performance metrics in IP
   networks using test packets [RFC8762].  It eliminates the need for
   control protocol by using configuration data model to provision test
   sessions.  [RFC8972] defines optional extensions for STAMP.

   This document specifies procedures for sending and processing test
   packets for Performance Measurement in SR networks.  The procedure
   uses the mechanisms defined in [RFC8762] (STAMP) and its optional
   extensions [RFC8972] for Performance Measurement.  The procedure
   specified is applicable to SR-MPLS and SRv6 data planes and is used
   for both links and end-to-end SR paths including SR Policies and
   Flex-Algo IGP Paths.  Unless otherwise specified, the mechanisms
   defined in [RFC8762] and [RFC8972] are not modified by this document.

2.  Conventions Used in This Document

2.1.  Requirements Language

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in [RFC2119] [RFC8174]
   when, and only when, they appear in all capitals, as shown here.

2.2.  Abbreviations

   BSID: Binding Segment ID.

   DM: Delay Measurement.

   ECMP: Equal Cost Multi-Path.

   HMAC: Hashed Message Authentication Code.

   LM: Loss Measurement.



Gandhi, et al.            Expires July 29, 2021                 [Page 3]

Internet-Draft       Using STAMP for Segment Routing        January 2021


   MPLS: Multiprotocol Label Switching.

   NTP: Network Time Protocol.

   OWAMP: One-Way Active Measurement Protocol.

   PM: Performance Measurement.

   PSID: Path Segment Identifier.

   PTP: Precision Time Protocol.

   SID: Segment ID.

   SL: Segment List.

   SR: Segment Routing.

   SRH: Segment Routing Header.

   SR-MPLS: Segment Routing with MPLS data plane.

   SRv6: Segment Routing with IPv6 data plane.

   SSID: STAMP Session Identifier.

   STAMP: Simple Two-way Active Measurement Protocol.

   TC: Traffic Class.

2.3.  Reference Topology

   In the reference topology shown below, the session-sender R1
   initiates a STAMP test packet and the session-reflector R3 sends a
   reply test packet.  The reply test packet is sent back to the
   session-sender R1.

   SR is enabled on nodes R1 and R3.  The nodes R1 and R3 may be
   directly connected via a link or there exists a Point-to-Point (P2P)
   SR path e.g.  SR Policy [I-D.ietf-spring-segment-routing-policy] on
   node R1 (called head-end) with destination to node R3 (called tail-
   end).









Gandhi, et al.            Expires July 29, 2021                 [Page 4]

Internet-Draft       Using STAMP for Segment Routing        January 2021


                          t1                t2
                         /                   \
                +-------+    Test Packet      +-------+
                |       | - - - - - - - - - ->|       |
                |   R1  |=====================|   R3  |
                |       |<- - - - - - - - - - |       |
                +-------+  Reply Test Packet  +-------+
                         \                   /
                          t4                t3
                 Session-Sender                        Session-Reflector

                         Reference Topology

3.  Overview

   For one-way and two-way delay measurements in Segment Routing
   networks, the test packets defined in [RFC8762] are used.  For
   direct-mode and inferred-mode loss measurements, the test packets
   defined in [I-D.gandhi-ippm-stamp-srpm] are used.  For both links and
   end-to-end SR paths including SR Policies and Flex-Algo IGP Paths, no
   PM state for delay or loss measurement need to be created on the
   session-reflector R3.

   Separate UDP destination port numbers are user-configured for delay
   and loss measurements from the range specified in [RFC8762].  As
   specified in [RFC8762], the session-reflector supports the
   destination UDP port 862 for delay measurement test packets by
   default.  This UDP port however, is not used for loss measurement
   test packets.  The session-sender uses the UDP port number following
   the guidelines specified in Section 6 in [RFC6335].  The same
   destination UDP port is used for links and SR paths and the session-
   reflector is unaware if the test packet is for the links or SR paths.
   The number of UDP ports with PM functionality needs to be minimized
   due to limited hardware resources.

   For Performance Measurement, test packet and reply test packets are
   sent as following:

   o  For delay measurement, the test packets are sent on the congruent
      path of the data traffic by the session-sender, and are used to
      measure the delay experienced by the actual data traffic flowing
      on the links and SR paths.

   o  For loss measurement, the test packets are sent on the congruent
      path of the data traffic by the session-sender, and are used to
      collect the receive traffic counters for the incoming link or
      incoming SID where the test packets are received at the session-




Gandhi, et al.            Expires July 29, 2021                 [Page 5]

Internet-Draft       Using STAMP for Segment Routing        January 2021


      reflector (incoming link or incoming SID needed since the session-
      reflector does not have PM state present).

   The In-Situ Operations, Administration, and Maintenance (IOAM)
   mechanisms for SR-MPLS defined in [I-D.gandhi-mpls-ioam-sr] and for
   SRv6 defined in [I-D.ali-spring-ioam-srv6] are used to carry PM
   information such as timestamp in-band as part of the data packets,
   and are outside the scope of this document.

3.1.  Example Provisioning Model

   An example of a provisioning model and typical measurement parameters
   for each user-configured destination UDP port for performance delay
   and loss measurements is shown in the following Figure 1:


                             +------------+
                             | Controller |
                             +------------+
   Destination UDP Port           /  \         Destination UDP port
   Measurement Protocol          /    \        Measurement Protocol
   Measurement Type             /      \       Measurement Type
     Delay/Loss                /        \        Delay/Loss
   Authentication Mode & Key  /          \     Authentication Mode & Key
   Timestamp Format          /            \    Loss Measurement Mode
   Delay Measurement Mode   /              \
   Loss Measurement Mode   /                \
                          v                  v
                     +-------+            +-------+
                     |       |            |       |
                     |   R1  |============|   R3  |
                     |       |  SR path   |       |
                     +-------+  Or link   +-------+

                     Session-Sender       Session-Reflector

                   Figure 1: Example Provisioning Model

   Example of Measurement Protocol is STAMP, example of the Timestamp
   Format is PTPv2 [IEEE1588] or NTP and example of the Loss Measurement
   mode is inferred-mode or direct-mode.

   The mechanisms to provision the session-sender and session-reflectors
   are outside the scope of this document.  The provisioning model is
   not used for signaling the PM parameters between the session-
   reflector and session-senders in SR networks.





Gandhi, et al.            Expires July 29, 2021                 [Page 6]

Internet-Draft       Using STAMP for Segment Routing        January 2021


   The session-reflector R3 uses the parameters for the timestamp format
   and delay measurement mode (i.e. one-way or two-way mode) from the
   received test packet.

4.  Test Packets

4.1.  Session-Sender Test Packet

   The test packets defined in [RFC8762] are used for delay measurement
   for links and end-to-end SR paths including SR Policies.  For loss
   measurement, the test packets defined in [I-D.gandhi-ippm-stamp-srpm]
   are used.

4.1.1.  Delay Measurement Query Message

   The packet content for delay measurement test packet using UDP header
   [RFC0768] is shown in Figure 2.  The DM test packet is sent with
   user-configured Destination UDP port number for DM.  The Destination
   UDP port cannot be used as Source port, since the packet does not
   have any indication to distinguish between the test packet and reply
   test packet.  The payload of the DM test packet contains the delay
   measurement packet defined in [RFC8762].

    +---------------------------------------------------------------+
    | IP Header                                                     |
    .  Source IP Address = Session-Sender IPv4 or IPv6 Address      .
    .  Destination IP Address=Session-Reflector IPv4 or IPv6 Address.
    .  Protocol = UDP                                               .
    .                                                               .
    +---------------------------------------------------------------+
    | UDP Header                                                    |
    .  Source Port = As chosen by Session-Sender                    .
    .  Destination Port = User-configured Port for Delay Measurement.
    .                                                               .
    +---------------------------------------------------------------+
    | Payload = DM Message as specified in Section 4.2 of RFC 8762  |
    .                                                               .
    +---------------------------------------------------------------+

                  Figure 2: DM Session-Sender Test Packet

   Timestamp field is eight bytes and use the format defined in
   Section 4.2.1 of [RFC8762].  It is recommended to use the IEEE 1588v2
   Precision Time Protocol (PTP) truncated 64-bit timestamp format
   [IEEE1588] as specified in [RFC8186], with hardware support in
   Segment Routing networks.





Gandhi, et al.            Expires July 29, 2021                 [Page 7]

Internet-Draft       Using STAMP for Segment Routing        January 2021


4.1.1.1.  Delay Measurement Authentication Mode

   When using the authenticated mode for delay measurement, the matching
   authentication type (e.g.  HMAC-SHA-256) and key are user-configured
   on both the session-sender and session-reflectors.  A separate user-
   configured destination UDP port is used for the delay measurement in
   authentication mode due to the different test packet format.

4.1.2.  Loss Measurement Query Message

   The packet content for loss measurement test packet using UDP header
   [RFC0768] is shown in Figure 3.  The LM test packet is sent with
   user-configured Destination UDP port number for LM, which is a
   different Destination UDP port number than DM.  Separate Destination
   UDP ports are used for direct-mode and inferred-mode loss
   measurements.  The Destination UDP port cannot be used as Source
   port, since the packet does not have any indication to distinguish
   between the test packet and reply test packet.  The LM test packet
   packet contains the payload for loss measurement as defined in [I-
   D.gandhi-ippm-stamp-srpm].

    +---------------------------------------------------------------+
    | IP Header                                                     |
    .  Source IP Address = Session-Sender IPv4 or IPv6 Address      .
    .  Destination IP Address=Session-Reflector IPv4 or IPv6 Address.
    .  Protocol = UDP                                               .
    .                                                               .
    +---------------------------------------------------------------+
    | UDP Header                                                    |
    .  Source Port = As chosen by Session-Sender                    .
    .  Destination Port = User-configured Port for Loss Measurement .
    .                                                               .
    +---------------------------------------------------------------+
    | Payload = LM Message specified in [I-D.gandhi-ippm-stamp-srpm]|
    .                                                               .
    +---------------------------------------------------------------+

                  Figure 3: LM Session-Sender Test Packet

4.1.2.1.  Loss Measurement Authentication Mode

   When using the authenticated mode for loss measurement, the matching
   authentication type (e.g.  HMAC-SHA-256) and key are user-configured
   on both the session-sender and session-reflectors.  A separate user-
   configured destination UDP port is used for the loss measurement in
   authentication mode due to the different packet format.





Gandhi, et al.            Expires July 29, 2021                 [Page 8]

Internet-Draft       Using STAMP for Segment Routing        January 2021


4.1.3.  Probe Query for links

   The test packet as defined in Figure 2 for delay measurement and
   Figure 3 for loss measurement are used for links which may be
   physical, virtual or LAG (bundle), LAG (bundle) member, numbered/
   unnumbered links.  The test packets are routed over the link for both
   delay and loss measurement.  The local and remote IP addresses of the
   link are used as Source and Destination Addresses.  They can also be
   IPv6 link local address as test packets are routed.

4.1.4.  Probe Query for SR Policy

   The performance delay and loss measurement for segment routing is
   applicable to both end-to-end SR-MPLS and SRv6 Policies.

   The session-sender IPv4 or IPv6 address is used as the source
   address.  The endpoint IPv4 or IPv6 address is used as the
   destination address.  In the case of SR Policy with IPv4 endpoint of
   0.0.0.0 or IPv6 endpoint of ::0
   [I-D.ietf-spring-segment-routing-policy], the loopback address from
   range 127/8 for IPv4, or the loopback address ::1/128 for IPv6 is
   used as the destination address, respectively.  In this case, Node
   Address TLV [I-D.gandhi-ippm-stamp-srpm] can be sent in the test
   packet to identify the intended destination node.  The session-
   reflector MUST NOT send reply test packet if it is not the intended
   destination node in the Node Address TLV [I-D.gandhi-ippm-stamp-
   srpm].

4.1.4.1.  Session-Sender Test Packet for SR-MPLS Policy

   The test packets for performance measurement of an end-to-end SR-MPLS
   Policy is sent using its SR-MPLS header containing the MPLS segment
   list as shown in Figure 4.


















Gandhi, et al.            Expires July 29, 2021                 [Page 9]

Internet-Draft       Using STAMP for Segment Routing        January 2021


    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                Segment(1)             | TC  |S|      TTL      |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    .                                                               .
    .                                                               .
    .                                                               .
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                Segment(n)             | TC  |S|      TTL      |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                PSID                   | TC  |S|      TTL      |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |   Message as shown in Figure 2 for DM or Figure 3 for LM      |
    .                                                               .
    +---------------------------------------------------------------+

      Figure 4: Example Session-Sender Test Packet for SR-MPLS Policy

   The Segment List (SL) can be empty to indicate Implicit NULL label
   case for a single-hop SR Policy.

   The Path Segment Identifier (PSID)
   [I-D.ietf-spring-mpls-path-segment] of the SR-MPLS Policy is used for
   accounting received traffic on the egress node for loss measurement.

4.1.4.2.  Session-Sender Test Packet for SRv6 Policy

   An SRv6 Policy setup using the SRv6 Segment Routing Header (SRH) and
   a Segment List as defined in [RFC8754].  The SRv6 network programming
   is defined in [I-D.ietf-spring-srv6-network-programming].  The test
   packets for performance measurement of an end-to-end SRv6 Policy is
   sent using its SRH with Segment List as shown in Figure 5.  The
   procedure defined for upper-layer header processing for SRv6 SIDs in
   [I-D.ietf-spring-srv6-network-programming] is used to process the UDP
   header in the received test packets.















Gandhi, et al.            Expires July 29, 2021                [Page 10]

Internet-Draft       Using STAMP for Segment Routing        January 2021


    +---------------------------------------------------------------+
    | IP Header                                                     |
    .  Source IP Address = Session-Sender IPv6 Address              .
    .  Destination IP Address = Destination IPv6 Address            .
    .                                                               .
    +---------------------------------------------------------------+
    | SRH as specified in RFC 8754                                  |
    .  <Segment List>                                               .
    .                                                               .
    +---------------------------------------------------------------+
    | IP Header (as needed)                                         |
    .  Source IP Address = Session-Sender IPv6 Address              .
    .  Destination IP Address = Session-Reflector IPv6 Address      .
    .                                                               .
    +---------------------------------------------------------------+
    | UDP Header                                                    |
    .  Source Port = As chosen by Session-Sender                    .
    .  Destination Port = User-configured Port                      .
    .                                                               .
    +---------------------------------------------------------------+
    | Payload = DM Message as specified in Section 4.2 of RFC 8762  |
    . Payload = LM Message specified in [I-D.gandhi-ippm-stamp-srpm].
    .                                                               .
    +---------------------------------------------------------------+

       Figure 5: Example Session-Sender Test Packet for SRv6 Policy

4.2.  Session-Reflector Test Packet

   The test reply test packet is sent using the IP/UDP information from
   the received test packet.  The content of the reply test packet is
   shown in Figure 6.



















Gandhi, et al.            Expires July 29, 2021                [Page 11]

Internet-Draft       Using STAMP for Segment Routing        January 2021


    +---------------------------------------------------------------+
    | IP Header                                                     |
    .  Source IP Address = Session-Reflector IPv4 or IPv6 Address   .
    .  Destination IP Address = Source IP Address from Query        .
    .  Protocol = UDP                                               .
    .                                                               .
    +---------------------------------------------------------------+
    | UDP Header                                                    |
    .  Source Port = As chosen by Session-Reflector                 .
    .  Destination Port = Source Port from Query                    .
    .                                                               .
    +---------------------------------------------------------------+
    | Payload = DM Message as specified in Section 4.3 of RFC 8762  |
    . Payload = LM Message specified in [I-D.gandhi-ippm-stamp-srpm].
    .                                                               .
    +---------------------------------------------------------------+

                  Figure 6: Session-Reflector Test Packet

4.2.1.  One-way Measurement Mode

   In one-way measurement mode, the test reply test packet as defined in
   Figure 6 is sent back out-of-band to the session-sender, for both
   links and SR Policies.  The Session-Sender Control Code is set to
   "Out-of-band Response Requested".  In this delay measurement mode, as
   per Reference Topology, all timestamps t1, t2, t3, and t4 are
   collected by the tests.  However, only timestamps t1 and t2 are used
   to measure one-way delay as (t2 - t1).

   For one-way performance measurement, the session-sender address may
   not be reachable via IP route from the session-reflector.  The
   session-sender in this case needs to send its reachability path
   information to the session-reflector using Return Path TLV defined in
   [I-D.gandhi-ippm-stamp-srpm].

4.2.2.  Two-way Measurement Mode

   In two-way measurement mode, when using a bidirectional path, the
   test reply test packet as defined in Figure 6 is sent back to the
   session-sender on the congruent path of the data traffic on the same
   reverse direction link or associated reverse SR Policy
   [I-D.ietf-pce-sr-bidir-path].  The Session-Sender Control Code is set
   to "In-band Response Requested".  In this delay measurement mode, as
   per Reference Topology, all timestamps t1, t2, t3, and t4 are
   collected by the tests.  All four timestamps are used to measure two-
   way delay as ((t4 - t1) - (t3 - t2)).





Gandhi, et al.            Expires July 29, 2021                [Page 12]

Internet-Draft       Using STAMP for Segment Routing        January 2021


   For two-way measurement mode for links, the test reply test packet is
   sent back on the incoming physical interface where the test packet is
   received.

   For two-way measurement mode for SR Policy, the session-reflector
   needs to send the test reply test packet on a specific reverse path.
   The session-sender node can request in the test packet to the
   session-reflector to send a reply test packet back on a given reverse
   path (e.g. co-routed bidirectional path) using Return Path TLV
   defined in [I-D.gandhi-ippm-stamp-srpm].  This way the session-
   reflector does not require any additional SR state for PM (recall
   that in SR networks, the state is in the test packet and signaling of
   the parameters is undesired).

4.2.2.1.  Session-Reflector Test Packet for SR-MPLS Policy

   The packet content for sending test reply test packet for two-way
   performance measurement of an end-to-end SR-MPLS Policy is shown in
   Figure 7.

    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                Segment(1)             | TC  |S|      TTL      |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    .                                                               .
    .                                                               .
    .                                                               .
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                Segment(n)             | TC  |S|      TTL      |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                Message as shown in Figure 6                   |
    .                                                               .
    +---------------------------------------------------------------+

    Figure 7: Example Session-Reflector Test Packet for SR-MPLS Policy

   The Path Segment Identifier (PSID)
   [I-D.ietf-spring-mpls-path-segment] of the forward SR Policy in the
   test packet can be used to find the associated reverse SR Policy
   [I-D.ietf-pce-sr-bidir-path] to send the test reply test packet for
   two-way measurement of SR Policy unless when using STAMP packet with
   Return Path TLV.








Gandhi, et al.            Expires July 29, 2021                [Page 13]

Internet-Draft       Using STAMP for Segment Routing        January 2021


4.2.2.2.  Session-Reflector Test Packet for SRv6 Policy

   The packet content for sending test reply test packet on the
   congruent path of the data traffic for two-way performance
   measurement of an end-to-end SRv6 Policy with SRH is shown in
   Figure 8.  The procedure defined for upper-layer header processing
   for SRv6 SIDs in [I-D.ietf-spring-srv6-network-programming] is used
   to process the UDP header in the received test reply test packets.

    +---------------------------------------------------------------+
    | IP Header                                                     |
    .  Source IP Address = Session-Reflector IPv6 Address           .
    .  Destination IP Address = Destination IPv6 Address            .
    .                                                               .
    +---------------------------------------------------------------+
    | SRH as specified in RFC 8754                                  |
    .  <Segment List>                                               .
    .                                                               .
    +---------------------------------------------------------------+
    | IP Header (as needed)                                         |
    .  Source IP Address = Session-Reflector IPv6 Address           .
    .  Destination IP Address = Source IPv6 Address from Query      .
    .                                                               .
    +---------------------------------------------------------------+
    | UDP Header                                                    |
    .  Source Port = As chosen by Session-Sender                    .
    .  Destination Port = User-configured Port                      .
    .                                                               .
    +---------------------------------------------------------------+
    | Payload = DM Message as specified in Section 4.3 of RFC 8762  |
    .                                                               .
    +---------------------------------------------------------------+

      Figure 8: Example Session-Reflector Test Packet for SRv6 Policy

4.2.3.  Loopback Measurement Mode

   The Loopback measurement mode can be used to measure round-trip delay
   for a bidirectional SR path.  The IP header of the test packet packet
   contains the destination address equals to the session-sender address
   and the source address equals to the session-reflector address.
   Optionally, the test packet can carry the reverse path information
   (e.g.  reverse path label stack for SR-MPLS) as part of the SR
   header.  The test packets are not punted at the session-reflector and
   it does not process them and generate reply test packets.  The
   Session-Sender Control Code is set to the default value of 0.  In
   this mode, as the test packet is not punted on the session-reflector
   for processing, the querier copies the 'Sequence Number' in 'Session-



Gandhi, et al.            Expires July 29, 2021                [Page 14]

Internet-Draft       Using STAMP for Segment Routing        January 2021


   Sender Sequence Number' directly.  In this delay measurement mode, as
   per Reference Topology, the timestamps t1 and t4 are collected by the
   tests.  Both these timestamps are used to measure round-trip delay as
   (t4 - t1).

4.3.  Additional Test Packet Processing Rules

   The processing rules defined in this section are applicable to the
   STAMP packets for delay and loss measurement for links and end-to-end
   SR paths including SR Policies.

4.3.1.  TTL and Hop Limit

   The TTL field in the IPv4 and MPLS headers of the test packets is set
   to 255 [RFC8762].  Similarly, the Hop Limit field in the IPv6 and SRH
   headers of the test packets is set to 255 [RFC8762].

   When using the Destination IPv4 Address from range 127/8, the TTL
   field in the IPv4 header is set to 1 [RFC8029].  Similarly, when
   using the Destination IPv6 Address from the ::FFFF:127/104 range, the
   Hop Limit field in the IPv6 header is set to 1.

   For link performance delay and loss measurements, the TTL or Hop
   Limit field in the test packet is set to 1 in both one-way and two-
   way measurement modes.

4.3.2.  Router Alert Option

   The Router Alert IP option (RAO) [RFC2113] is not set in the test
   packets.

5.  Performance Measurement for P2MP SR Policies

   The Point-to-Multipoint (P2MP) SR path that originates from a root
   node terminates on multiple destinations called leaf nodes (e.g.
   P2MP SR Policy [I-D.ietf-pim-sr-p2mp-policy] or P2MP Transport
   [I-D.shen-spring-p2mp-transport-chain]).

   The procedures for delay and loss measurement described in this
   document for P2P SR Policies are also equally applicable to the P2MP
   SR Policies.  The procedure for one-way measurement is defined as
   following:

   o  The session-sender root node sends test packets using the Tree-SID
      defined in [I-D.ietf-pim-sr-p2mp-policy] for the P2MP SR-MPLS
      Policy as shown in Figure 9.





Gandhi, et al.            Expires July 29, 2021                [Page 15]

Internet-Draft       Using STAMP for Segment Routing        January 2021


   o  The test packets can contain the replication SID as defined in
      [I-D.ietf-spring-sr-replication-segment].

   o  The Destination Address is set to the loopback address from range
      127/8 for IPv4, or the loopback address ::1/128 for IPv6 address.

   o  Each session-reflector leaf node sends its IP address in the
      Source Address of the test reply test packets as shown in
      Figure 9.  This allows the session-sender root node to identify
      the session-reflector leaf nodes of the P2MP SR Policy.

   o  The P2MP root node measures the delay and loss performance for
      each P2MP leaf node of the end-to-end P2MP SR Policy.


    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |              Tree-SID                 | TC  |S|      TTL      |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    .                                                               .
    .                                                               .
    .                                                               .
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |   Message as shown in Figure 2 for DM or Figure 3 for LM      |
    .                                                               .
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

      Figure 9: Example Probe Query with Tree-SID for SR-MPLS Policy

   The test packets can also be sent using the scheme defined for P2MP
   Transport using Chain Replication that may contain Bud SID as defined
   in [I-D.shen-spring-p2mp-transport-chain].

   The considerations for two-way mode for performance measurement for
   P2MP SR Policy (e.g. for bidirectional SR path) are outside the scope
   of this document.

6.  ECMP Support for SR Policies

   An SR Policy can have ECMPs between the source and transit nodes,
   between transit nodes and between transit and destination nodes.
   Usage of Anycast SID [RFC8402] by an SR Policy can result in ECMP
   paths via transit nodes part of that Anycast group.  The test packets
   need to be sent to traverse different ECMP paths to measure
   performance delay of an SR Policy.





Gandhi, et al.            Expires July 29, 2021                [Page 16]

Internet-Draft       Using STAMP for Segment Routing        January 2021


   Forwarding plane has various hashing functions available to forward
   packets on specific ECMP paths.  The mechanisms described in
   [RFC8029] and [RFC5884] for handling ECMPs are also applicable to the
   performance measurement.  In IPv4 header of the test packets,
   sweeping of Destination Address from range 127/8 can be used to
   exercise particular ECMP paths.  As specified in [RFC6437], Flow
   Label field in the outer IPv6 header can also be used for sweeping.

   The considerations for performance loss measurement for different
   ECMP paths of an SR Policy are outside the scope of this document.

7.  Performance Delay and Liveness Monitoring

   Liveness monitoring is required for connectivity verification and
   continuity check in an SR network.  The procedure defined in this
   document for delay measurement using the STAMP test packets can also
   be applied to liveness monitoring of links and SR paths.  The one-way
   or two-way measurement mode can be used for liveness monitoring.
   Liveness failure is notified when consecutive N number of test reply
   test packets are not received back at the session-sender, where N is
   locally provisioned value.  Note that for one-way and two-way modes,
   the failure detection interval and scale for number of test packets
   need to account for the processing of the test packets which need to
   be punted from the forwarding fast path (to slow path or control
   plane) and reply test packets need to be injected on the session-
   reflector.  This is improved by using the tests in loopback mode.

8.  Security Considerations

   The performance measurement is intended for deployment in well-
   managed private and service provider networks.  As such, it assumes
   that a node involved in a measurement operation has previously
   verified the integrity of the path and the identity of the far-end
   session-reflector.

   If desired, attacks can be mitigated by performing basic validation
   and sanity checks, at the session-sender, of the counter or timestamp
   fields in received measurement reply test packets.  The minimal state
   associated with these protocols also limits the extent of measurement
   disruption that can be caused by a corrupt or invalid packet to a
   single test cycle.

   Use of HMAC-SHA-256 in the authenticated mode protects the data
   integrity of the test packets.  SRv6 has HMAC protection
   authentication defined for SRH [RFC8754].  Hence, test packets for
   SRv6 may not need authentication mode.  Cryptographic measures may be
   enhanced by the correct configuration of access-control lists and
   firewalls.



Gandhi, et al.            Expires July 29, 2021                [Page 17]

Internet-Draft       Using STAMP for Segment Routing        January 2021


9.  IANA Considerations

   This document does not require any IANA action.

10.  References

10.1.  Normative References

   [RFC0768]  Postel, J., "User Datagram Protocol", STD 6, RFC 768,
              DOI 10.17487/RFC0768, August 1980,
              <https://www.rfc-editor.org/info/rfc768>.

   [RFC2119]  Bradner, S., "Key words for use in RFCs to Indicate
              Requirement Levels", BCP 14, RFC 2119,
              DOI 10.17487/RFC2119, March 1997,
              <https://www.rfc-editor.org/info/rfc2119>.

   [RFC8174]  Leiba, B., "Ambiguity of Uppercase vs Lowercase in RFC
              2119 Key Words", BCP 14, RFC 8174, DOI 10.17487/RFC8174,
              May 2017, <https://www.rfc-editor.org/info/rfc8174>.

   [RFC8762]  Mirsky, G., Jun, G., Nydell, H., and R. Foote, "Simple
              Two-Way Active Measurement Protocol", RFC 8762,
              DOI 10.17487/RFC8762, March 2020,
              <https://www.rfc-editor.org/info/rfc8762>.

   [RFC8972]  Mirsky, G., Min, X., Nydell, H., Foote, R., Masputra, A.,
              and E. Ruffini, "Simple Two-Way Active Measurement
              Protocol Optional Extensions", RFC 8972,
              DOI 10.17487/RFC8972, January 2021,
              <https://www.rfc-editor.org/info/rfc8972>.

   [I-D.gandhi-ippm-stamp-srpm]
              Gandhi, R., Filsfils, C., Voyer, D., Chen, M., and B.
              Janssens, "Simple TWAMP (STAMP) Extensions for Segment
              Routing Networks", draft-gandhi-ippm-stamp-srpm-01 (work
              in progress), January 2021.

10.2.  Informative References

   [IEEE1588]
              IEEE, "1588-2008 IEEE Standard for a Precision Clock
              Synchronization Protocol for Networked Measurement and
              Control Systems", March 2008.

   [RFC2113]  Katz, D., "IP Router Alert Option", RFC 2113,
              DOI 10.17487/RFC2113, February 1997,
              <https://www.rfc-editor.org/info/rfc2113>.



Gandhi, et al.            Expires July 29, 2021                [Page 18]

Internet-Draft       Using STAMP for Segment Routing        January 2021


   [RFC5884]  Aggarwal, R., Kompella, K., Nadeau, T., and G. Swallow,
              "Bidirectional Forwarding Detection (BFD) for MPLS Label
              Switched Paths (LSPs)", RFC 5884, DOI 10.17487/RFC5884,
              June 2010, <https://www.rfc-editor.org/info/rfc5884>.

   [RFC6335]  Cotton, M., Eggert, L., Touch, J., Westerlund, M., and S.
              Cheshire, "Internet Assigned Numbers Authority (IANA)
              Procedures for the Management of the Service Name and
              Transport Protocol Port Number Registry", BCP 165,
              RFC 6335, DOI 10.17487/RFC6335, August 2011,
              <https://www.rfc-editor.org/info/rfc6335>.

   [RFC6437]  Amante, S., Carpenter, B., Jiang, S., and J. Rajahalme,
              "IPv6 Flow Label Specification", RFC 6437,
              DOI 10.17487/RFC6437, November 2011,
              <https://www.rfc-editor.org/info/rfc6437>.

   [RFC8029]  Kompella, K., Swallow, G., Pignataro, C., Ed., Kumar, N.,
              Aldrin, S., and M. Chen, "Detecting Multiprotocol Label
              Switched (MPLS) Data-Plane Failures", RFC 8029,
              DOI 10.17487/RFC8029, March 2017,
              <https://www.rfc-editor.org/info/rfc8029>.

   [RFC8186]  Mirsky, G. and I. Meilik, "Support of the IEEE 1588
              Timestamp Format in a Two-Way Active Measurement Protocol
              (TWAMP)", RFC 8186, DOI 10.17487/RFC8186, June 2017,
              <https://www.rfc-editor.org/info/rfc8186>.

   [RFC8402]  Filsfils, C., Ed., Previdi, S., Ed., Ginsberg, L.,
              Decraene, B., Litkowski, S., and R. Shakir, "Segment
              Routing Architecture", RFC 8402, DOI 10.17487/RFC8402,
              July 2018, <https://www.rfc-editor.org/info/rfc8402>.

   [RFC8754]  Filsfils, C., Ed., Dukes, D., Ed., Previdi, S., Leddy, J.,
              Matsushima, S., and D. Voyer, "IPv6 Segment Routing Header
              (SRH)", RFC 8754, DOI 10.17487/RFC8754, March 2020,
              <https://www.rfc-editor.org/info/rfc8754>.

   [I-D.ietf-spring-segment-routing-policy]
              Filsfils, C., Talaulikar, K., Voyer, D., Bogdanov, A., and
              P. Mattes, "Segment Routing Policy Architecture", draft-
              ietf-spring-segment-routing-policy-09 (work in progress),
              November 2020.








Gandhi, et al.            Expires July 29, 2021                [Page 19]

Internet-Draft       Using STAMP for Segment Routing        January 2021


   [I-D.ietf-spring-sr-replication-segment]
              Voyer, D., Filsfils, C., Parekh, R., Bidgoli, H., and Z.
              Zhang, "SR Replication Segment for Multi-point Service
              Delivery", draft-ietf-spring-sr-replication-segment-03
              (work in progress), October 2020.

   [I-D.shen-spring-p2mp-transport-chain]
              Shen, Y., Zhang, Z., Parekh, R., Bidgoli, H., and Y.
              Kamite, "Point-to-Multipoint Transport Using Chain
              Replication in Segment Routing", draft-shen-spring-p2mp-
              transport-chain-03 (work in progress), October 2020.

   [I-D.ietf-pim-sr-p2mp-policy]
              Voyer, D., Filsfils, C., Parekh, R., Bidgoli, H., and Z.
              Zhang, "Segment Routing Point-to-Multipoint Policy",
              draft-ietf-pim-sr-p2mp-policy-01 (work in progress),
              October 2020.

   [I-D.ietf-spring-mpls-path-segment]
              Cheng, W., Li, H., Chen, M., Gandhi, R., and R. Zigler,
              "Path Segment in MPLS Based Segment Routing Network",
              draft-ietf-spring-mpls-path-segment-03 (work in progress),
              September 2020.

   [I-D.ietf-spring-srv6-network-programming]
              Filsfils, C., Camarillo, P., Leddy, J., Voyer, D.,
              Matsushima, S., and Z. Li, "SRv6 Network Programming",
              draft-ietf-spring-srv6-network-programming-28 (work in
              progress), December 2020.

   [I-D.gandhi-mpls-ioam-sr]
              Gandhi, R., Ali, Z., Filsfils, C., Brockners, F., Wen, B.,
              and V. Kozak, "MPLS Data Plane Encapsulation for In-situ
              OAM Data", draft-gandhi-mpls-ioam-sr-05 (work in
              progress), January 2021.

   [I-D.ali-spring-ioam-srv6]
              Ali, Z., Gandhi, R., Filsfils, C., Brockners, F., Nainar,
              N., Pignataro, C., Li, C., Chen, M., and G. Dawra,
              "Segment Routing Header encapsulation for In-situ OAM
              Data", draft-ali-spring-ioam-srv6-03 (work in progress),
              November 2020.









Gandhi, et al.            Expires July 29, 2021                [Page 20]

Internet-Draft       Using STAMP for Segment Routing        January 2021


   [I-D.ietf-pce-sr-bidir-path]
              Li, C., Chen, M., Cheng, W., Gandhi, R., and Q. Xiong,
              "Path Computation Element Communication Protocol (PCEP)
              Extensions for Associated Bidirectional Segment Routing
              (SR) Paths", draft-ietf-pce-sr-bidir-path-04 (work in
              progress), January 2021.

Acknowledgments

   The authors would like to thank Thierry Couture for the discussions
   on the use-cases for Performance Measurement in Segment Routing.  The
   authors would also like to thank Greg Mirsky for reviewing this
   document and providing useful comments and suggestions.  Patrick
   Khordoc and Radu Valceanu, both from Cisco Systems have helped
   significantly improve the mechanisms defined in this document.  The
   authors would also like to thank Sam Aldrin for the discussions to
   check for broken path.

Authors' Addresses

   Rakesh Gandhi (editor)
   Cisco Systems, Inc.
   Canada

   Email: rgandhi@cisco.com


   Clarence Filsfils
   Cisco Systems, Inc.

   Email: cfilsfil@cisco.com


   Daniel Voyer
   Bell Canada

   Email: daniel.voyer@bell.ca


   Mach(Guoyi) Chen
   Huawei

   Email: mach.chen@huawei.com








Gandhi, et al.            Expires July 29, 2021                [Page 21]

Internet-Draft       Using STAMP for Segment Routing        January 2021


   Bart Janssens
   Colt

   Email: Bart.Janssens@colt.net















































Gandhi, et al.            Expires July 29, 2021                [Page 22]
