<?xml version='1.0' encoding='utf-8'?>
<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [
<!ENTITY RFC0768 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.0768.xml">
<!ENTITY RFC2119 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.2119.xml">
<!ENTITY RFC8174 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8174.xml">
<!ENTITY RFC8762 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8762.xml">
<!ENTITY RFC8972 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8972.xml">
<!ENTITY RFC2104 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.2104.xml">
<!ENTITY RFC2113 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.2113.xml">
<!ENTITY RFC4868 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.4868.xml">
<!ENTITY RFC5884 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.5884.xml">
<!ENTITY RFC6335 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.6335.xml">
<!ENTITY RFC6437 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.6437.xml">
<!ENTITY RFC6936 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.6936.xml">
<!ENTITY RFC7820 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.7820.xml">
<!ENTITY RFC8029 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8029.xml">
<!ENTITY RFC8085 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8085.xml">
<!ENTITY RFC8126 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8126.xml">
<!ENTITY RFC8186 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8186.xml">
<!ENTITY RFC8321 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8321.xml">
<!ENTITY RFC8402 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8402.xml">
<!ENTITY RFC8754 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8754.xml">
<!ENTITY I-D.ietf-spring-segment-routing-policy SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-spring-segment-routing-policy.xml">
<!ENTITY I-D.ietf-spring-sr-replication-segment SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-spring-sr-replication-segment.xml">
<!ENTITY I-D.ietf-pim-sr-p2mp-policy SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-pim-sr-p2mp-policy.xml">
<!ENTITY I-D.shen-spring-p2mp-transport-chain SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.shen-spring-p2mp-transport-chain.xml">
<!ENTITY I-D.ietf-spring-mpls-path-segment SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-spring-mpls-path-segment.xml">
<!ENTITY I-D.ietf-spring-srv6-network-programming SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-spring-srv6-network-programming.xml">
<!ENTITY I-D.ietf-pce-binding-label-sid SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-pce-binding-label-sid.xml">
<!ENTITY I-D.gandhi-mpls-ioam-sr SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.gandhi-mpls-ioam-sr.xml">
<!ENTITY I-D.ali-spring-ioam-srv6 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ali-spring-ioam-srv6.xml">
<!ENTITY I-D.ietf-pce-sr-bidir-path SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-pce-sr-bidir-path.xml">
<!ENTITY I-D.gandhi-spring-sr-enhanced-plm SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.gandhi-spring-sr-enhanced-plm.xml">
<!ENTITY I-D.gandhi-ippm-stamp-srpm SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.gandhi-ippm-stamp-srpm.xml">
]>
<rfc submissionType="IETF" docName="draft-gandhi-spring-stamp-srpm-05" category="std" ipr="trust200902">
	<!-- Generated by id2xml 1.5.0 on 2020-02-06T01:41:26Z -->
	<?rfc compact="yes"?>
	<?rfc text-list-symbols="oo*+-"?>
	<?rfc subcompact="no"?>
	<?rfc sortrefs="no"?>
	<?rfc symrefs="yes"?>
	<?rfc strict="yes"?>
	<?rfc toc="yes"?>
	<front>
	<title abbrev="Using STAMP for Segment Routing">Performance Measurement Using Simple TWAMP (STAMP) for Segment Routing Networks</title>
	<author fullname="Rakesh Gandhi" initials="R." role="editor" surname="Gandhi">
	<organization>Cisco Systems, Inc.</organization>
	<address><postal><street>Canada</street>
	</postal>
        <email>rgandhi@cisco.com</email>
	</address>
	</author>

	<author fullname="Clarence Filsfils" initials="C." surname="Filsfils">
	<organization>Cisco Systems, Inc.</organization>
        <address>
        <email>cfilsfil@cisco.com</email>
	</address>
	</author>

	<author fullname="Daniel Voyer" initials="D." surname="Voyer">
	<organization>Bell Canada</organization>
        <address>
        <email>daniel.voyer@bell.ca</email>
	</address>
	</author>

	<author fullname="Mach(Guoyi) Chen" initials="M." surname="Chen">
	<organization>Huawei</organization>
        <address>
        <email>mach.chen@huawei.com</email>
	</address>
	</author>

	<author fullname="Bart Janssens" initials="B." surname="Janssens">
	<organization>Colt</organization>
        <address>
	<email>Bart.Janssens@colt.net</email>
	</address>
	</author>

	<date day="25" month="January" year="2021"/>
	<workgroup>SPRING Working Group</workgroup>
	<abstract><t>
   Segment Routing (SR) leverages the source routing paradigm.  SR is
   applicable to both Multiprotocol Label Switching (SR-MPLS) and IPv6
   (SRv6) data planes.  This document specifies procedure for sending
   and processing test packets for Performance
   Measurement (PM) in Segment Routing networks.  The procedure uses the
   mechanisms defined in RFC 8762 (Simple Two-Way Active Measurement Protocol (STAMP))
   and its optional extensions defined in RFC 8972 for Performance Measurement. 
   The procedure specified is applicable
   to SR-MPLS and SRv6 data planes and is used for both links and
   end-to-end SR paths including SR Policies.</t>
	</abstract>
	</front>

	<middle>
	<section title="Introduction" anchor="sect-1"><t>
   Segment Routing (SR) leverages the source routing paradigm and
   greatly simplifies network operations for Software Defined Networks
   (SDNs).  SR is applicable to both Multiprotocol Label Switching
   (SR-MPLS) and IPv6 (SRv6) data planes.  SR takes advantage of the
   Equal-Cost Multipaths (ECMPs) between source and transit nodes,
   between transit nodes and between transit and destination nodes.  SR
   Policies as defined in <xref target="I-D.ietf-spring-segment-routing-policy"/> are used
   to steer traffic through a specific, user-defined paths using a stack
   of Segments.  Built-in SR Performance Measurement (PM) is one of the
   essential requirements to provide Service Level Agreements (SLAs).</t>

   <t>
   The Simple Two-way Active Measurement Protocol (STAMP) provides
   capabilities for the measurement of various performance
   metrics in IP networks using test packets <xref target="RFC8762"/>. 
   It eliminates the need for control protocol by using
   configuration data model to provision test sessions. 
   <xref target="RFC8972"/> defines optional extensions for STAMP.</t>

   <t>This document specifies procedures for sending and processing 
   test packets for Performance Measurement in SR
   networks.  The procedure uses the mechanisms defined in <xref target="RFC8762"/> 
   (STAMP) and its optional extensions <xref target="RFC8972"/> 
   for Performance Measurement.
   The procedure specified is applicable to SR-MPLS and SRv6 data planes and
   is used for both links and end-to-end SR paths including SR Policies and Flex-Algo IGP Paths.  
   Unless otherwise specified, the mechanisms 
   defined in <xref target="RFC8762"/> and <xref target="RFC8972"/>
   are not modified by this document.</t>
	</section>

	<section title="Conventions Used in This Document" anchor="sect-2"><section title="Requirements Language" anchor="sect-2.1"><t>
   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in <xref target="RFC2119"/> <xref target="RFC8174"/>
   when, and only when, they appear in all capitals, as shown here.</t>

	</section>

	<section title="Abbreviations" anchor="sect-2.2"><t>
   BSID: Binding Segment ID.</t>

	<t>
   DM: Delay Measurement.</t>

	<t>
   ECMP: Equal Cost Multi-Path.</t>

	<t>
   HMAC: Hashed Message Authentication Code.</t>

	<t>
   LM: Loss Measurement.</t>

	<t>
   MPLS: Multiprotocol Label Switching.</t>

	<t>
   NTP: Network Time Protocol.</t>

	<t>
   OWAMP: One-Way Active Measurement Protocol.</t>

	<t>
   PM: Performance Measurement.</t>

	<t>
   PSID: Path Segment Identifier.</t>

	<t>
   PTP: Precision Time Protocol.</t>

	<t>
   SID: Segment ID.</t>

	<t>
   SL: Segment List.</t>

	<t>
   SR: Segment Routing.</t>

	<t>
   SRH: Segment Routing Header.</t>

	<t>
   SR-MPLS: Segment Routing with MPLS data plane.</t>

	<t>
   SRv6: Segment Routing with IPv6 data plane.</t>

	<t>
   SSID: STAMP Session Identifier.</t>

	<t>
   STAMP: Simple Two-way Active Measurement Protocol.</t>

	<t>
   TC: Traffic Class.</t>

	</section>

	<section title="Reference Topology" anchor="sect-2.3"><t>
   In the reference topology shown below, the session-sender R1 initiates a
   STAMP test packet and the session-reflector R3
   sends a reply test packet.  The 
   reply test packet is sent back to the session-sender R1.</t>  

   <t>SR is enabled on nodes R1 and R3. The nodes R1 and R3 may be
   directly connected via a link or there
   exists a Point-to-Point (P2P) SR path e.g. SR Policy
   <xref target="I-D.ietf-spring-segment-routing-policy"/> on node R1 (called head-end)
   with destination to node R3 (called tail-end).</t>

	<figure><artwork><![CDATA[
                       t1                t2
                      /                   \
             +-------+    Test Packet      +-------+
             |       | - - - - - - - - - ->|       |
             |   R1  |=====================|   R3  |
             |       |<- - - - - - - - - - |       |
             +-------+  Reply Test Packet  +-------+
                      \                   /
                       t4                t3
              Session-Sender                        Session-Reflector

                      Reference Topology
]]></artwork>
	</figure>
	</section>

	</section>

	<section title="Overview" anchor="sect-3"><t>
   For one-way and two-way delay measurements in Segment
   Routing networks, the test packets defined in
   <xref target="RFC8762"/> are used.  For direct-mode and
   inferred-mode loss measurements, the test 
   packets defined in [I-D.gandhi-ippm-stamp-srpm] are used. 
   For both links and end-to-end SR paths including SR Policies and Flex-Algo IGP Paths,
   no PM state for delay or loss measurement need to be created on the
   session-reflector R3.</t> 
   
   <t>Separate UDP destination port numbers are user-configured for delay and loss
   measurements from the range specified in <xref target="RFC8762"/>. 
   As specified in <xref target="RFC8762"/>, the session-reflector supports the destination
   UDP port 862 for delay measurement test packets by default. This UDP port however, is 
   not used for loss measurement test packets. The
   session-sender uses the UDP port number following the guidelines specified in
   <xref target="sect-6"/> in <xref target="RFC6335"/>. The same destination UDP 
   port is used for links and SR paths and the session-reflector is 
   unaware if the test packet is for the links or SR paths. The number of UDP ports with 
   PM functionality needs to be minimized due to limited hardware resources.</t>

   <t>For Performance Measurement, test packet and reply test packets are
   sent as following:</t>

	<t><list style="symbols"><t>For delay measurement, the test packets are sent on the
      congruent path of the data traffic by the session-sender, and are
      used to measure the delay experienced by the actual data traffic
      flowing on the links and SR paths.</t>

	<t>For loss measurement, the test packets are sent on the congruent
      path of the data traffic by the session-sender, and are used to
      collect the receive traffic counters for the incoming link or
      incoming SID where the test packets are received at the
      session-reflector (incoming link or incoming SID needed since the
      session-reflector does not have PM state present).</t>

	</list>
	</t>

	<t>
   The In-Situ Operations, Administration, and Maintenance (IOAM)
   mechanisms for SR-MPLS defined in <xref target="I-D.gandhi-mpls-ioam-sr"/> and for
   SRv6 defined in <xref target="I-D.ali-spring-ioam-srv6"/> are used to carry PM
   information such as timestamp in-band as part of the data packets,
   and are outside the scope of this document.</t>

	<section title="Example Provisioning Model" anchor="sect-3.1"><t>
   An example of a provisioning model and typical measurement parameters for each user-configured destination UDP port 
   for performance delay and loss measurements is shown in the following
   Figure 1:</t>

   <figure title="Example Provisioning Model" anchor="ure-example-provisioning-model"><artwork><![CDATA[

                          +------------+
                          | Controller |
                          +------------+
Destination UDP Port           /  \         Destination UDP port
Measurement Protocol          /    \        Measurement Protocol
Measurement Type             /      \       Measurement Type
  Delay/Loss                /        \        Delay/Loss
Authentication Mode & Key  /          \     Authentication Mode & Key
Timestamp Format          /            \    Loss Measurement Mode
Delay Measurement Mode   /              \   
Loss Measurement Mode   /                \
                       v                  v
                  +-------+            +-------+
                  |       |            |       |
                  |   R1  |============|   R3  |
                  |       |  SR path   |       |
                  +-------+  Or link   +-------+

                  Session-Sender       Session-Reflector
]]></artwork>
	</figure>

    <t>Example of Measurement Protocol is STAMP, 
    example of the Timestamp Format is PTPv2 <xref target="IEEE1588"/> or NTP 
    and example of the Loss Measurement mode is inferred-mode or direct-mode.</t>

    <t>The mechanisms to provision the
    session-sender and session-reflectors are outside the scope of this document. 
    The provisioning model is not used for signaling the PM parameters between the 
    session-reflector and session-senders in SR networks.</t>

    <t>The session-reflector R3 uses the parameters for the timestamp format and
    delay measurement mode (i.e. one-way or two-way mode)
    from the received test packet.</t>
	</section>

	</section>

	<section title="Test Packets" anchor="sect-4"><section title="Session-Sender Test Packet" anchor="sect-4.1"><t>
   The test packets defined in <xref target="RFC8762"/> are used
   for delay measurement for links and end-to-end SR paths including SR 
   Policies. For loss measurement, the test packets defined in [I-D.gandhi-ippm-stamp-srpm] are used.</t>


   <section title="Delay Measurement Query Message" anchor="sect-4.1.1"><t>
   The packet content for delay measurement test packet using
   UDP header <xref target="RFC0768"/> is shown in Figure 2.  The DM test packet
   is sent with user-configured Destination UDP port number for DM.  The
   Destination UDP port cannot be used as Source port, since the packet
   does not have any indication to distinguish between the test packet and
   reply test packet.  The payload of the DM test packet contains the delay
   measurement packet defined in <xref target="RFC8762"/>.</t> 

	<figure title="DM Session-Sender Test Packet" anchor="ure-dm-sender-test-packet"><artwork><![CDATA[
 +---------------------------------------------------------------+
 | IP Header                                                     |
 .  Source IP Address = Session-Sender IPv4 or IPv6 Address      .
 .  Destination IP Address=Session-Reflector IPv4 or IPv6 Address.
 .  Protocol = UDP                                               .
 .                                                               .
 +---------------------------------------------------------------+
 | UDP Header                                                    |
 .  Source Port = As chosen by Session-Sender                    .
 .  Destination Port = User-configured Port for Delay Measurement.
 .                                                               .
 +---------------------------------------------------------------+
 | Payload = DM Message as specified in Section 4.2 of RFC 8762  |
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
	</figure>

	<t>Timestamp field is eight bytes and use the format defined in Section
   4.2.1 of <xref target="RFC8762"/>.  It is recommended to use the IEEE 1588v2
   Precision Time Protocol (PTP) truncated 64-bit timestamp format
   <xref target="IEEE1588"/> as specified in <xref target="RFC8186"/>, with hardware support
   in Segment Routing networks.</t>


	<section title="Delay Measurement Authentication Mode" anchor="sect-4.1.1.1"><t>
   When using the authenticated mode for delay measurement, the matching
   authentication type (e.g. HMAC-SHA-256) and key are user-configured
   on both the session-sender and session-reflectors.  A separate user-configured
   destination UDP port is used for the delay measurement in
   authentication mode due to the different test packet format.</t>

	</section>
	</section>


	<section title="Loss Measurement Query Message" anchor="sect-4.1.2"><t>
   The packet content for loss measurement test packet using
   UDP header <xref target="RFC0768"/> is shown in Figure 3. The LM test packet
   is sent with user-configured Destination UDP port number for LM, 
   which is a different Destination UDP port number than DM.
   Separate Destination UDP ports are used for direct-mode and
   inferred-mode loss measurements.  The Destination UDP port cannot be
   used as Source port, since the packet does not have any indication
   to distinguish between the test packet and reply test packet.  The LM test packet
   packet contains the payload for loss measurement as defined in
   [I-D.gandhi-ippm-stamp-srpm].</t>

	<figure title="LM Session-Sender Test Packet" anchor="ure-lm-sender-test-packet1"><artwork><![CDATA[
 +---------------------------------------------------------------+
 | IP Header                                                     |
 .  Source IP Address = Session-Sender IPv4 or IPv6 Address      .
 .  Destination IP Address=Session-Reflector IPv4 or IPv6 Address.
 .  Protocol = UDP                                               .
 .                                                               .
 +---------------------------------------------------------------+
 | UDP Header                                                    |
 .  Source Port = As chosen by Session-Sender                    .
 .  Destination Port = User-configured Port for Loss Measurement .
 .                                                               .
 +---------------------------------------------------------------+
 | Payload = LM Message specified in [I-D.gandhi-ippm-stamp-srpm]|
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
	</figure>

	<section title="Loss Measurement Authentication Mode" anchor="sect-4.1.2.1"><t>
   When using the authenticated mode for loss measurement, the matching
   authentication type (e.g. HMAC-SHA-256) and key are user-configured
   on both the session-sender and session-reflectors.  A separate user-configured
   destination UDP port is used for the loss measurement in
   authentication mode due to the different packet format.</t>

    </section>
    </section>

	<section title="Probe Query for links" anchor="sect-4.1.3"><t>
   The test packet as defined in Figure 2 for delay measurement and 
   Figure 3 for loss measurement are used for links which may be physical, virtual 
   or LAG (bundle), LAG (bundle) member, numbered/unnumbered links.  The test packets are routed 
   over the link for both delay and loss measurement. 
   The local and remote IP addresses of the link are used as Source and Destination Addresses. 
   They can also be IPv6 link local address as test packets are routed.</t>
	</section>

	<section title="Probe Query for SR Policy" anchor="sect-4.1.4"><t>
   The performance delay and loss measurement for segment routing is
   applicable to both end-to-end SR-MPLS and SRv6 Policies.</t>

	<t>The session-sender IPv4 or IPv6 address is used as the source address. 
   The endpoint IPv4 or IPv6 address is used as the destination
   address.  In the case of SR Policy with IPv4 endpoint
   of 0.0.0.0 or IPv6 endpoint of ::0
   <xref target="I-D.ietf-spring-segment-routing-policy"/>,
   the loopback address from range 127/8 for IPv4, or the loopback address ::1/128 
   for IPv6 is used as the destination address, respectively. 
   In this case, Node Address TLV [I-D.gandhi-ippm-stamp-srpm] can be sent 
   in the test packet to identify the intended destination node.
   The session-reflector MUST NOT send reply test packet if it
   is not the intended destination node in the Node Address TLV 
   [I-D.gandhi-ippm-stamp-srpm].</t>

	<section title="Session-Sender Test Packet for SR-MPLS Policy" anchor="sect-4.1.4.1"><t>
   The test packets for performance measurement of an
   end-to-end SR-MPLS Policy is sent using its SR-MPLS header containing the MPLS
   segment list as shown in Figure 4.</t>

	<figure title="Example Session-Sender Test Packet for SR-MPLS Policy" anchor="ure-test-packet-for-sr-mpls-policy"><artwork><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                Segment(1)             | TC  |S|      TTL      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 .                                                               .
 .                                                               .
 .                                                               .
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                Segment(n)             | TC  |S|      TTL      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                PSID                   | TC  |S|      TTL      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |   Message as shown in Figure 2 for DM or Figure 3 for LM      |
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
	</figure>
	<t>
   The Segment List (SL) can be empty to indicate Implicit NULL label
   case for a single-hop SR Policy.</t>

	<t>
   The Path Segment Identifier (PSID) <xref target="I-D.ietf-spring-mpls-path-segment"/> of
   the SR-MPLS Policy is used for accounting received traffic on the
   egress node for loss measurement.</t>

	</section>

	<section title="Session-Sender Test Packet for SRv6 Policy" anchor="sect-4.1.4.2"><t>
   An SRv6 Policy setup using the SRv6 Segment Routing Header (SRH) and
   a Segment List as defined in <xref target="RFC8754"/>. 
   The SRv6 network programming is defined in 
   <xref target="I-D.ietf-spring-srv6-network-programming"/>. 
   The test packets for performance measurement of an end-to-end 
   SRv6 Policy is sent using its SRH with Segment List as shown in Figure 5.
   The procedure defined for upper-layer header processing for SRv6 SIDs in <xref target="I-D.ietf-spring-srv6-network-programming"/>
   is used to process the UDP header in the received test packets.</t>

	<figure title="Example Session-Sender Test Packet for SRv6 Policy" anchor="ure-test-packet-for-srv6-policy"><artwork><![CDATA[
 +---------------------------------------------------------------+
 | IP Header                                                     |
 .  Source IP Address = Session-Sender IPv6 Address              .
 .  Destination IP Address = Destination IPv6 Address            .
 .                                                               .
 +---------------------------------------------------------------+
 | SRH as specified in RFC 8754                                  |
 .  <Segment List>                                               .
 .                                                               .
 +---------------------------------------------------------------+
 | IP Header (as needed)                                         |
 .  Source IP Address = Session-Sender IPv6 Address              .
 .  Destination IP Address = Session-Reflector IPv6 Address      .
 .                                                               .
 +---------------------------------------------------------------+
 | UDP Header                                                    |
 .  Source Port = As chosen by Session-Sender                    .
 .  Destination Port = User-configured Port                      .
 .                                                               .
 +---------------------------------------------------------------+
 | Payload = DM Message as specified in Section 4.2 of RFC 8762  |
 . Payload = LM Message specified in [I-D.gandhi-ippm-stamp-srpm].
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
	</figure>


	</section>
        </section>
	</section>

	<section title="Session-Reflector Test Packet" anchor="sect-4.2"><t>
   The test reply test packet is sent using the IP/UDP information from
   the received test packet.  The content of the reply test
   packet is shown in Figure 6.</t>

	<figure title="Session-Reflector Test Packet" anchor="ure-test-response-packet"><artwork><![CDATA[
 +---------------------------------------------------------------+
 | IP Header                                                     |
 .  Source IP Address = Session-Reflector IPv4 or IPv6 Address   .
 .  Destination IP Address = Source IP Address from Query        .
 .  Protocol = UDP                                               .
 .                                                               .
 +---------------------------------------------------------------+
 | UDP Header                                                    |
 .  Source Port = As chosen by Session-Reflector                 .
 .  Destination Port = Source Port from Query                    .
 .                                                               .
 +---------------------------------------------------------------+
 | Payload = DM Message as specified in Section 4.3 of RFC 8762  |
 . Payload = LM Message specified in [I-D.gandhi-ippm-stamp-srpm].
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
	</figure>
	<section title="One-way Measurement Mode" anchor="sect-4.2.1"><t>
   In one-way measurement mode, the test reply test packet
   as defined in Figure 6 is sent back out-of-band to the session-sender,
   for both links and SR Policies. The Session-Sender Control Code is set to
   "Out-of-band Response Requested". 
   In this delay measurement mode, as per Reference Topology, 
   all timestamps t1, t2, t3, and t4 are collected by the tests.
   However, only timestamps t1 and t2 are used to measure one-way delay as (t2 - t1).</t>

	<t> For one-way performance measurement, the session-sender address may not
   be reachable via IP route from the session-reflector.  The session-sender
   in this case needs to send its reachability path information to the
   session-reflector using Return Path TLV defined in [I-D.gandhi-ippm-stamp-srpm].</t>

	</section>

	<section title="Two-way Measurement Mode" anchor="sect-4.2.2"><t>
   In two-way measurement mode, when using a bidirectional
   path, the test reply test packet as defined in Figure 6 is sent back
   to the session-sender on the congruent path of the data traffic on the
   same reverse direction link or associated reverse SR Policy
   <xref target="I-D.ietf-pce-sr-bidir-path"/>.  The Session-Sender Control Code is 
   set to "In-band Response Requested".
   In this delay measurement mode, as per Reference Topology, 
   all timestamps t1, t2, t3, and t4 are collected by the tests.
   All four timestamps are used to measure two-way delay as ((t4 - t1) - (t3 - t2)).</t>

	<t>For two-way measurement mode for links, the test reply test packet is sent back on the incoming physical
   interface where the test packet is received.</t>

	<t>For two-way measurement mode for SR Policy, the session-reflector needs to send
   the test reply test packet on a specific reverse path.  The session-sender
   node can request in the test packet to the session-reflector to
   send a reply test packet back on a given reverse path (e.g. co-routed
   bidirectional path) using Return Path TLV defined in [I-D.gandhi-ippm-stamp-srpm].  
   This way the session-reflector does not require
   any additional SR state for PM (recall that in SR networks, 
   the state is in the test packet and signaling of the parameters is undesired).</t>

	<section title="Session-Reflector Test Packet for SR-MPLS Policy" anchor="sect-4.2.2.1"><t>
   The packet content for sending test reply test packet for two-way
   performance measurement of an end-to-end SR-MPLS Policy is shown in
   Figure 7.</t>

	<figure title="Example Session-Reflector Test Packet for SR-MPLS Policy" anchor="ure-test-response-packet-for-sr-mpls-policy"><artwork><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                Segment(1)             | TC  |S|      TTL      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 .                                                               .
 .                                                               .
 .                                                               .
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                Segment(n)             | TC  |S|      TTL      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                Message as shown in Figure 6                   |
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
	</figure>
	<t>
   The Path Segment Identifier (PSID) <xref target="I-D.ietf-spring-mpls-path-segment"/> of
   the forward SR Policy in the test packet can be used to find the
   associated reverse SR Policy <xref target="I-D.ietf-pce-sr-bidir-path"/> to send the test
   reply test packet for two-way measurement of SR Policy unless when using STAMP packet with Return
   Path TLV.</t>

	</section>

	<section title="Session-Reflector Test Packet for SRv6 Policy" anchor="sect-4.2.2.2"><t>
   The packet content for sending test reply test packet on the
   congruent path of the data traffic for two-way performance
   measurement of an end-to-end SRv6 Policy with SRH is shown in Figure 8.
   The procedure defined for upper-layer header processing for SRv6 SIDs in <xref target="I-D.ietf-spring-srv6-network-programming"/>
   is used to process the UDP header in the received test reply test packets.</t>

	<figure title="Example Session-Reflector Test Packet for SRv6 Policy" anchor="ure-test-response-packet-for-srv6-policy"><artwork><![CDATA[
 +---------------------------------------------------------------+
 | IP Header                                                     |
 .  Source IP Address = Session-Reflector IPv6 Address           .
 .  Destination IP Address = Destination IPv6 Address            .
 .                                                               .
 +---------------------------------------------------------------+
 | SRH as specified in RFC 8754                                  |
 .  <Segment List>                                               .
 .                                                               .
 +---------------------------------------------------------------+
 | IP Header (as needed)                                         |
 .  Source IP Address = Session-Reflector IPv6 Address           .
 .  Destination IP Address = Source IPv6 Address from Query      .
 .                                                               .
 +---------------------------------------------------------------+
 | UDP Header                                                    |
 .  Source Port = As chosen by Session-Sender                    .
 .  Destination Port = User-configured Port                      .
 .                                                               .
 +---------------------------------------------------------------+
 | Payload = DM Message as specified in Section 4.3 of RFC 8762  |
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
	</figure>

	</section>
	</section>

        <section title="Loopback Measurement Mode" anchor="sect-4.2.3"><t>
   The Loopback measurement mode can be used to measure round-trip delay
   for a bidirectional SR path.  The IP header of the test packet
   packet contains the destination address equals to the session-sender address
   and the source address equals to the session-reflector address. Optionally,
   the test packet can carry the reverse path information (e.g.
   reverse path label stack for SR-MPLS) as part of the SR header.  The
   test packets are not punted at the session-reflector and it does
   not process them and generate reply test packets.
   The Session-Sender Control Code is set to the default value of 0.
   In this mode, as the test packet is not punted on the session-reflector for processing,
   the querier copies the 'Sequence Number' in 'Session-Sender Sequence Number' directly.
   In this delay measurement mode, as per Reference Topology,
   the timestamps t1 and t4 are collected by the tests.
   Both these timestamps are used to measure round-trip delay as (t4 - t1).</t>
        </section>
	</section>

	<section title="Additional Test Packet Processing Rules" anchor="sect-4.5"><t>
   The processing rules defined in this section are applicable to the
   STAMP packets for delay and loss measurement for links and end-to-end SR paths including SR Policies.</t>		
		
        <section title="TTL and Hop Limit" anchor="sect-4.5.1"><t>
   The TTL field in the IPv4 and MPLS headers of the
   test packets is set to 255 <xref target="RFC8762"/>.
   Similarly, the Hop Limit field in the IPv6 and SRH headers of the
   test packets is set to 255 <xref target="RFC8762"/>.</t>

	<t>When using the Destination IPv4 Address from range 127/8, the TTL field
   in the IPv4 header is set to 1 <xref target="RFC8029"/>.  Similarly, when using the
   Destination IPv6 Address from the ::FFFF:127/104 range, the
   Hop Limit field in the IPv6 header is set to 1.</t>

        <t>For link performance delay and loss measurements, 
   the TTL or Hop Limit field in the test packet is set to 1 in both one-way and two-way measurement modes. 
       </t>

	</section>

	<section title="Router Alert Option" anchor="sect-4.5.2"><t>
   The Router Alert IP option (RAO) <xref target="RFC2113"/> is not set in the test packets.</t>

	</section>

	</section>
	</section>

	<section title="Performance Measurement for P2MP SR Policies" anchor="sect-5"> <t>
   The Point-to-Multipoint (P2MP) SR path
   that originates from a root node terminates on multiple destinations called leaf nodes 
   (e.g. P2MP SR Policy <xref target="I-D.ietf-pim-sr-p2mp-policy"/> 
   or P2MP Transport <xref target="I-D.shen-spring-p2mp-transport-chain"/>).</t>

   <t>The procedures for delay and loss measurement described in this
   document for P2P SR Policies are also equally applicable to the P2MP SR Policies. 
   The procedure for one-way measurement is defined as following:</t>

	<t><list style="symbols"><t>The session-sender root node sends test packets using the
      Tree-SID defined in <xref target="I-D.ietf-pim-sr-p2mp-policy"/> for the
      P2MP SR-MPLS Policy as shown in Figure 9.</t>

        <t>The test packets can contain
      the replication SID as defined in <xref target="I-D.ietf-spring-sr-replication-segment"/>.</t>

        <t>The Destination Address is set to the loopback 
      address from range 127/8 for IPv4, or the loopback address ::1/128 for IPv6 address.</t>

	<t>Each session-reflector leaf node sends its IP address in the Source
      Address of the test reply test packets as shown in Figure 9.  This
      allows the session-sender root node to identify the session-reflector leaf nodes
      of the P2MP SR Policy.</t>

	<t>The P2MP root node measures the delay and loss
      performance for each P2MP leaf node of the end-to-end P2MP SR Policy.</t>

	</list>
	</t>

	<figure title="Example Probe Query with Tree-SID for SR-MPLS Policy" anchor="ure-with-replication-segment-for-sr-mpls-policy"><artwork><![CDATA[

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |              Tree-SID                 | TC  |S|      TTL      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 .                                                               .
 .                                                               .
 .                                                               .
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |   Message as shown in Figure 2 for DM or Figure 3 for LM      |
 .                                                               .
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
	</figure>


    <t>The test packets can also be sent using
   the scheme defined for P2MP Transport using Chain Replication that may contain Bud SID as defined in 
   <xref target="I-D.shen-spring-p2mp-transport-chain"/>.</t>

    <t>The considerations for two-way mode for performance measurement for 
   P2MP SR Policy (e.g. for bidirectional SR path) are outside the scope of this document.</t>

	</section>

	<section title="ECMP Support for SR Policies" anchor="sect-6"><t>
   An SR Policy can have ECMPs between the source and transit nodes,
   between transit nodes and between transit and destination nodes.
   Usage of Anycast SID <xref target="RFC8402"/> by an SR Policy can result in ECMP
   paths via transit nodes part of that Anycast group.  The test
   packets need to be sent to traverse different ECMP paths to measure
   performance delay of an SR Policy.</t>

	<t>Forwarding plane has various hashing functions available to forward
   packets on specific ECMP paths.  The mechanisms described in
   <xref target="RFC8029"/> and <xref target="RFC5884"/> for 
   handling ECMPs are also applicable to the
   performance measurement.  In IPv4 header of the test packets,
   sweeping of Destination Address from range 127/8 can be used to exercise
   particular ECMP paths.  As specified in <xref target="RFC6437"/>, Flow Label field in
   the outer IPv6 header can also be used for sweeping.</t>

	<t>The considerations for performance loss measurement for different
   ECMP paths of an SR Policy are outside the scope of this document.</t>

	</section>


        <section title="Performance Delay and Liveness Monitoring" anchor="sect-7"><t>
    Liveness monitoring is required for connectivity verification and continuity check in an SR network.
    The procedure defined in this document for delay measurement using the STAMP test 
    packets can also be applied to liveness monitoring of links and SR paths. 
    The one-way or two-way measurement mode can be used for liveness monitoring.  
    Liveness failure is notified when consecutive N number of test reply test packets are
    not received back at the session-sender, where N is locally provisioned value. 
    Note that for one-way and two-way modes, the failure detection interval and scale for number of test packets need to account for 
    the processing of the test packets which need to be punted from the forwarding fast path
    (to slow path or control plane) and reply test packets need to be injected on the session-reflector.
    This is improved by using the tests in loopback mode.</t>
         </section>

	<section title="Security Considerations" anchor="sect-8"><t>
   The performance measurement is intended for deployment in
   well-managed private and service provider networks.  As such, it
   assumes that a node involved in a measurement operation has
   previously verified the integrity of the path and the identity of the
   far-end session-reflector.</t>

	<t>If desired, attacks can be mitigated by performing basic validation
   and sanity checks, at the session-sender, of the counter or timestamp fields
   in received measurement reply test packets.  The minimal state
   associated with these protocols also limits the extent of measurement
   disruption that can be caused by a corrupt or invalid packet to a
   single test cycle.</t>

	<t>Use of HMAC-SHA-256 in the authenticated mode protects the data
   integrity of the test packets.  SRv6 has HMAC protection
   authentication defined for SRH <xref target="RFC8754"/>.
   Hence, test packets for SRv6 may not need authentication mode.
   Cryptographic measures may be enhanced by the correct configuration
   of access-control lists and firewalls.</t>

	</section>

	<section title="IANA Considerations" anchor="sect-9"><t>
       This document does not require any IANA action.</t>

	</section>

	</middle>

	<back>
	<references title="Normative References">
	&RFC0768;
	&RFC2119;
	&RFC8174;
	&RFC8762;
	&RFC8972;
        &I-D.gandhi-ippm-stamp-srpm;		
	</references>
	<references title="Informative References">
	<reference anchor="IEEE1588"><front>
	<title>1588-2008 IEEE Standard for a Precision Clock Synchronization Protocol for Networked Measurement and Control Systems</title>
	<author>
	<organization>IEEE</organization>
	</author>

	<date month="March" year="2008"/>
	</front>

	</reference>
	&RFC2113;
	&RFC5884;
	&RFC6335;
	&RFC6437;
	&RFC8029;
	&RFC8186;
	&RFC8402;
	&RFC8754;
	&I-D.ietf-spring-segment-routing-policy;
	&I-D.ietf-spring-sr-replication-segment;
	&I-D.shen-spring-p2mp-transport-chain;
	&I-D.ietf-pim-sr-p2mp-policy;
	&I-D.ietf-spring-mpls-path-segment;
	&I-D.ietf-spring-srv6-network-programming;
	&I-D.gandhi-mpls-ioam-sr;
	&I-D.ali-spring-ioam-srv6;
	&I-D.ietf-pce-sr-bidir-path;
	</references>
	<section title="Acknowledgments" numbered="no" anchor="acknowledgments"><t>
   The authors would like to thank Thierry Couture for the discussions
   on the use-cases for Performance Measurement in Segment Routing.  The authors
   would also like to thank Greg Mirsky for reviewing this document and
   providing useful comments and suggestions.  Patrick Khordoc and Radu
   Valceanu, both from Cisco Systems have helped significantly improve
   the mechanisms defined in this document.  The authors
   would also like to thank Sam Aldrin for the discussions to check for
   broken path.</t>

	</section>

	</back>

	</rfc>
